<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io 编辑器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
        }
        
        /* 浮动工具栏 */
        .floating-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toolbar-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .toolbar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .toolbar-btn:active {
            transform: translateY(-1px);
        }
        
        .toolbar-btn.save-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .toolbar-btn.download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .toolbar-btn.back-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .toolbar-btn .tooltip-text {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .toolbar-btn:hover .tooltip-text {
            opacity: 1;
        }
        
        /* 保存状态指示器 */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        /* 保存提示框 */
        .save-hint {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            font-weight: bold;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .save-status.show {
            display: flex;
        }
        
        .save-status.saving {
            background: rgba(255, 193, 7, 0.95);
        }
        
        .save-status.saved {
            background: rgba(40, 167, 69, 0.95);
            color: white;
        }
        
        .save-status.error {
            background: rgba(220, 53, 69, 0.95);
            color: white;
        }
        
        .drawio-container {
            height: 100vh;
            width: 100vw;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #6c757d;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* 文件名输入模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .modal-buttons .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .modal-buttons .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-buttons button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- 保存状态指示器 -->
    <div id="save-status" class="save-status">
        <span class="spinner-border spinner-border-sm"></span>
        <span id="status-text">保存中...</span>
    </div>
    
    <!-- 保存提示（首次打开时显示） -->
    <div id="save-hint" class="save-hint" style="display: none;">
        💾 按Ctrl+S保存到服务器
    </div>
    
    <!-- 浮动工具栏 -->
    <div class="floating-toolbar">
        <button id="upload-btn" class="toolbar-btn upload-btn" title="打开本地文件" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            📂
            <span class="tooltip-text">打开本地文件</span>
        </button>
        <button id="download-btn" class="toolbar-btn download-btn" title="下载到本地">
            📥
            <span class="tooltip-text">下载</span>
        </button>
        <button id="back-btn" class="toolbar-btn back-btn" title="返回">
            ←
            <span class="tooltip-text">返回</span>
        </button>
    </div>
    
    <!-- 隐藏的文件输入 -->
    <input type="file" id="file-input" accept=".drawio,.xml,.dio" style="display: none;" />
    
    <!-- 文件名输入模态框 -->
    <div id="filename-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>保存文件</h3>
            <input type="text" id="filename-input" placeholder="请输入文件名（自动添加.drawio）" />
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeFilenameModal()">取消</button>
                <button class="btn-primary" onclick="saveWithFilename()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- Draw.io 编辑器容器 -->
    <div class="drawio-container">
        <div id="loading" class="loading-spinner">
            <div class="spinner-border spinner"></div>
            <span>正在加载 Draw.io 编辑器...</span>
        </div>
        <iframe id="drawio-iframe" src="" style="display: none;"></iframe>
    </div>
    
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 从服务器传递的数据
        let currentFilepath = {{ filepath|tojson|safe }} || null;
        let initialContent = {{ diagram_content|tojson|safe }} || '';
        let isModified = false;
        let drawioIframe = null;
        let drawioReady = false;
        
        // 提取当前目录路径（用于保存新文件）
        let currentDir = '';
        if (currentFilepath) {
            const lastSlash = currentFilepath.lastIndexOf('/');
            if (lastSlash !== -1) {
                currentDir = currentFilepath.substring(0, lastSlash + 1);
            }
        }
        
        // 调试输出
        console.log('[DEBUG] ===== 页面加载调试信息 =====');
        console.log('[DEBUG] currentFilepath:', currentFilepath);
        console.log('[DEBUG] currentDir:', currentDir);
        console.log('[DEBUG] currentFilepath type:', typeof currentFilepath);
        console.log('[DEBUG] initialContent:', initialContent ? initialContent.substring(0, 100) + '...' : 'NULL');
        console.log('[DEBUG] initialContent length:', initialContent ? initialContent.length : 0);
        console.log('[DEBUG] initialContent type:', typeof initialContent);
        console.log('[DEBUG] ================================');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            drawioIframe = document.getElementById('drawio-iframe');
            
            // 构建iframe URL
            // 配置Draw.io为离线模式，保留完整编辑界面
            // embed=1: 启用embed模式，支持postMessage API
            // proto=json: 使用JSON格式通信
            let iframeSrc = '/drawio?offline=1&stealth=1&local=1&sync=none&mode=device&lang=zh&embed=1&proto=json';
            
            console.log('[DEBUG] 设置iframe src...');
            console.log('[DEBUG] 是否有初始内容:', !!initialContent, '长度:', initialContent?.length);
            drawioIframe.src = iframeSrc;
            
            // 监听Draw.io的init事件
            let drawioInitialized = false;
            const initListener = function(e) {
                try {
                    let data = e.data;
                    
                    // 解析JSON字符串
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (parseErr) {
                            return;
                        }
                    }
                    
                    // 监听init事件
                    if (data && data.event === 'init' && !drawioInitialized) {
                        console.log('[DEBUG] Draw.io已初始化（收到init事件）');
                        drawioInitialized = true;
                        
                        // Draw.io初始化完成，立即加载内容
                        try {
                            if (initialContent && initialContent.length > 0) {
                                console.log('[DEBUG] 使用postMessage load动作加载文件内容');
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: initialContent,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] 已发送load消息（响应init），内容长度:', initialContent.length);
                            } else {
                                console.log('[DEBUG] 没有初始内容，创建新图表');
                                const emptyDiagram = '<mxfile><diagram id="new" name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: emptyDiagram,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] 已发送空白图表（响应init）');
                            }
                            
                            // 配置Draw.io
                            const configMsg = JSON.stringify({
                                action: 'configure',
                                config: {
                                    defaultEdgeLength: 80
                                }
                            });
                            drawioIframe.contentWindow.postMessage(configMsg, '*');
                            console.log('[DEBUG] 已配置Draw.io（embed模式）');
                        } catch (e) {
                            console.error('[ERROR] 配置或加载Draw.io失败:', e);
                        }
                    }
                } catch (err) {
                    // 忽略
                }
            };
            window.addEventListener('message', initListener);
            
            // 等待iframe加载完成
            drawioIframe.onload = function() {
                console.log('[DEBUG] iframe加载完成');
                document.getElementById('loading').style.display = 'none';
                drawioIframe.style.display = 'block';
                drawioReady = true;
                
                // 显示保存提示（5秒后自动消失）
                if (currentFilepath) {
                    const hint = document.getElementById('save-hint');
                    hint.style.display = 'block';
                    setTimeout(() => {
                        hint.style.opacity = '0';
                        hint.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 500);
                    }, 5000);
                }
                
                // 备用：如果3秒内没收到init事件，强制加载
                setTimeout(() => {
                    if (!drawioInitialized) {
                        console.log('[DEBUG] 超时，强制加载内容');
                        try {
                            if (initialContent && initialContent.length > 0) {
                                console.log('[DEBUG] 强制使用postMessage load动作加载文件内容');
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: initialContent,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] 已强制发送load消息，内容长度:', initialContent.length);
                            } else {
                                console.log('[DEBUG] 没有初始内容，创建新图表');
                                const emptyDiagram = '<mxfile><diagram id="new" name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: emptyDiagram,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] 已强制发送空白图表');
                            }
                            
                            // 配置Draw.io
                            const configMsg = JSON.stringify({
                                action: 'configure',
                                config: {
                                    defaultEdgeLength: 80
                                }
                            });
                            drawioIframe.contentWindow.postMessage(configMsg, '*');
                            console.log('[DEBUG] 已配置Draw.io（embed模式）');
                        } catch (e) {
                            console.error('[ERROR] 强制配置或加载Draw.io失败:', e);
                        }
                    }
                }, 3000);
            };
            
            // 绑定按钮事件
            document.getElementById('upload-btn').addEventListener('click', openLocalFile);
            // save-btn已移除，使用Ctrl+S保存
            document.getElementById('download-btn').addEventListener('click', downloadFile);
            document.getElementById('back-btn').addEventListener('click', goBack);
            
            // 绑定文件输入事件
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
            
            // 全局autosave监听器（捕获所有autosave事件）
            let lastAutosaveXml = null;
            window.addEventListener('message', function(e) {
                try {
                    let data = e.data;
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (parseErr) {
                            return;
                        }
                    }
                    
                    // 始终记录最新的autosave内容
                    if (data && data.event === 'autosave' && data.xml) {
                        lastAutosaveXml = data.xml;
                        console.log('[DEBUG] 记录autosave内容，长度:', lastAutosaveXml.length);
                    }
                } catch (err) {
                    // 忽略
                }
            });
            
            // 监听键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl+S 保存
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    // 直接使用最新的autosave内容
                    if (lastAutosaveXml) {
                        console.log('[DEBUG] 使用缓存的autosave内容保存');
                        if (currentFilepath) {
                            saveToServer(currentFilepath, lastAutosaveXml);
                        } else {
                            showFilenameModal(lastAutosaveXml);
                        }
                    } else {
                        saveFile();
                    }
                }
            });
            
            // 监听来自Draw.io的消息
            window.addEventListener('message', handleDrawioMessage);
            
            // 额外添加一个调试监听器，捕获所有消息
            window.addEventListener('message', function(e) {
                try {
                    let data = e.data;
                    
                    // 如果是JSON字符串，尝试解析
                    let parsedData = data;
                    if (typeof data === 'string') {
                        try {
                            parsedData = JSON.parse(data);
                        } catch (parseErr) {
                            // 不是JSON，保持原样
                        }
                    }
                    
                    // 详细记录所有消息
                    console.log('[DEBUG] 收到原始消息:', {
                        dataType: typeof data,
                        isJSON: typeof data === 'string' && typeof parsedData === 'object',
                        event: parsedData?.event,
                        origin: e.origin,
                        source: e.source === drawioIframe?.contentWindow ? 'Draw.io iframe' : 'other'
                    });
                    
                    // 特别监听save相关的消息
                    if (typeof parsedData === 'object' && parsedData !== null) {
                        if (parsedData.event === 'save' || parsedData.event === 'saveAs' || parsedData.event === 'autosave') {
                            console.log('[DEBUG] *** 检测到保存事件 ***', parsedData.event);
                            
                            // 如果是save或saveAs事件
                            if (parsedData.event === 'save' || parsedData.event === 'saveAs') {
                                // 阻止默认行为
                                e.stopPropagation && e.stopPropagation();
                                
                                // 获取XML内容并保存到服务器
                                if (parsedData.xml) {
                                    console.log('[DEBUG] 保存事件包含XML，长度:', parsedData.xml.length);
                                    if (currentFilepath) {
                                        saveToServer(currentFilepath, parsedData.xml);
                                    } else {
                                        showFilenameModal(parsedData.xml);
                                    }
                                } else {
                                    console.log('[DEBUG] 保存事件不包含XML，请求导出');
                                    saveFile();
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error('[ERROR] 处理原始消息失败:', err);
                }
            });
        });
        
        // 打开本地文件
        function openLocalFile() {
            document.getElementById('file-input').click();
        }
        
        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const xml = e.target.result;
                
                // 确保文件名有.drawio扩展名
                let filename = file.name;
                if (!filename.endsWith('.drawio')) {
                    filename += '.drawio';
                }
                
                // 保存到当前目录
                const uploadFilepath = currentDir ? currentDir + filename : filename;
                console.log('[DEBUG] 上传本地文件到:', uploadFilepath);
                
                // 保存到服务器
                saveToServer(uploadFilepath, xml);
                
                // 加载到编辑器（使用embed模式的load）
                const loadMsg = JSON.stringify({
                    action: 'load',
                    xml: xml,
                    autosave: 1
                });
                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                
                currentFilepath = uploadFilepath;
                showSaveStatus('saved', '文件已上传到服务器');
            };
            
            reader.readAsText(file);
            
            // 重置input以允许重新选择相同文件
            event.target.value = '';
        }
        
        // 处理来自Draw.io的消息
        function handleDrawioMessage(event) {
            try {
                let data = event.data;
                
                // 如果是JSON字符串，解析它
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        // 不是JSON，忽略
                        return;
                    }
                }
                
                if (typeof data === 'object' && data !== null) {
                    console.log('[DEBUG] 收到Draw.io消息:', data);
                    
                    // 监听内容变化
                    if (data.event === 'modified') {
                        isModified = true;
                        console.log('[DEBUG] 内容已修改');
                    }
                    
                    // 拦截保存事件
                    if (data.event === 'save') {
                        console.log('[DEBUG] 拦截到Draw.io的保存事件');
                        event.preventDefault && event.preventDefault();
                        
                        // 如果有文件路径，保存到服务器；否则询问文件名
                        if (data.xml) {
                            if (currentFilepath) {
                                saveToServer(currentFilepath, data.xml);
                            } else {
                                showFilenameModal(data.xml);
                            }
                        } else {
                            // 如果事件中没有xml，主动请求导出
                            saveFile();
                        }
                        return;
                    }
                    
                    // 监听自动保存
                    if (data.event === 'autosave') {
                        console.log('[DEBUG] 自动保存事件触发');
                        if (currentFilepath && data.xml) {
                            autoSaveToServer(data.xml);
                        }
                    }
                    
                // 响应导出请求（已在saveFile中处理，这里不需要额外处理）
                // if (data.event === 'export' && data.data) {
                //     // 导出事件已由saveFile函数处理
                // }
                }
            } catch (e) {
                console.error('[ERROR] 处理Draw.io消息失败:', e);
            }
        }
        
        // 保存文件
        function saveFile() {
            console.log('[DEBUG] 请求保存...');
            showSaveStatus('saving');
            
            // 方案：模拟Ctrl+S按键，触发Draw.io的autosave
            try {
                console.log('[DEBUG] 模拟Ctrl+S快捷键...');
                
                // 设置autosave监听器
                let saveReceived = false;
                const handleAutosave = function(event) {
                    try {
                        let data = event.data;
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);
                            } catch (e) {
                                return;
                            }
                        }
                        
                        if (data && data.event === 'autosave' && data.xml && !saveReceived) {
                            saveReceived = true;
                            window.removeEventListener('message', handleAutosave);
                            
                            const xml = data.xml;
                            console.log('[DEBUG] 捕获autosave，XML长度:', xml.length);
                            console.log('[DEBUG] XML前100字符:', xml.substring(0, 100));
                            
                            if (!xml.includes('<mxfile') && !xml.includes('<?xml')) {
                                console.error('[ERROR] XML格式无效');
                                showSaveStatus('error', '保存失败');
                                return;
                            }
                            
                            if (currentFilepath) {
                                saveToServer(currentFilepath, xml);
                            } else {
                                showFilenameModal(xml);
                            }
                        }
                    } catch (e) {
                        console.error('[ERROR]', e);
                    }
                };
                
                window.addEventListener('message', handleAutosave);
                
                // 向iframe发送Ctrl+S按键事件
                const iframe = drawioIframe;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // 创建键盘事件
                const keydownEvent = new KeyboardEvent('keydown', {
                    key: 's',
                    code: 'KeyS',
                    keyCode: 83,
                    which: 83,
                    ctrlKey: true,
                    bubbles: true,
                    cancelable: true
                });
                
                const keyupEvent = new KeyboardEvent('keyup', {
                    key: 's',
                    code: 'KeyS',
                    keyCode: 83,
                    which: 83,
                    ctrlKey: true,
                    bubbles: true,
                    cancelable: true
                });
                
                console.log('[DEBUG] 触发键盘事件...');
                iframeDoc.dispatchEvent(keydownEvent);
                iframeDoc.dispatchEvent(keyupEvent);
                
                // 超时处理
                setTimeout(() => {
                    if (!saveReceived) {
                        console.warn('[WARN] 未捕获到autosave事件');
                        window.removeEventListener('message', handleAutosave);
                        showSaveStatus('saved', '已触发保存');
                        
                        // 提示用户手动确认
                        setTimeout(() => {
                            if (confirm('未检测到自动保存响应。\n\n请在Draw.io中按Ctrl+S保存，然后点击"确定"再次尝试保存到服务器。')) {
                                saveFile();
                            } else {
                                showSaveStatus('error');
                            }
                        }, 100);
                    }
                }, 2000);
                
            } catch (e) {
                console.error('[ERROR] 保存失败:', e);
                showSaveStatus('error');
            }
        }
        
        // 保存到服务器
        function saveToServer(filepath, content) {
            showSaveStatus('saving');
            
            fetch('/drawio_save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filepath: filepath,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSaveStatus('saved');
                    isModified = false;
                    currentFilepath = filepath;
                } else {
                    showSaveStatus('error', data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('保存错误:', error);
                showSaveStatus('error', '网络错误');
            });
        }
        
        // 自动保存（静默）
        function autoSaveToServer(content) {
            if (!currentFilepath) return;
            
            fetch('/drawio_save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filepath: currentFilepath,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('自动保存成功');
                }
            })
            .catch(error => {
                console.error('自动保存失败:', error);
            });
        }
        
        // 显示保存状态
        function showSaveStatus(status, message) {
            const statusEl = document.getElementById('save-status');
            const textEl = document.getElementById('status-text');
            
            statusEl.className = 'save-status show ' + status;
            
            if (status === 'saving') {
                textEl.textContent = '保存中...';
            } else if (status === 'saved') {
                textEl.textContent = message || '保存成功 ✓';
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 2000);
            } else if (status === 'error') {
                textEl.textContent = message || '保存失败 ✗';
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }
        
        // 显示文件名输入框
        function showFilenameModal(xml) {
            window.pendingXml = xml;
            document.getElementById('filename-modal').classList.add('show');
            document.getElementById('filename-input').focus();
        }
        
        // 关闭文件名输入框
        function closeFilenameModal() {
            document.getElementById('filename-modal').classList.remove('show');
            window.pendingXml = null;
        }
        
        // 使用文件名保存
        function saveWithFilename() {
            let filename = document.getElementById('filename-input').value.trim();
            
            if (!filename) {
                alert('请输入文件名');
                return;
            }
            
            // 确保有.drawio扩展名
            if (!filename.endsWith('.drawio')) {
                filename += '.drawio';
            }
            
            // 保存到当前目录，如果没有当前目录则保存到根目录
            const filepath = currentDir ? currentDir + filename : filename;
            console.log('[DEBUG] 保存新文件到:', filepath);
            
            // 更新currentFilepath以便后续保存
            currentFilepath = filepath;
            
            saveToServer(filepath, window.pendingXml);
            closeFilenameModal();
        }
        
        // 下载文件
        function downloadFile() {
            console.log('[DEBUG] 请求下载文件...');
            
            let downloadReceived = false;
            
            const handleDownload = function(event) {
                try {
                    let data = event.data;
                    
                    // 如果是JSON字符串，解析它
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (e) {
                            return;
                        }
                    }
                    
                    if (data && data.event === 'export' && !downloadReceived) {
                        const xml = data.data || data.xml;
                        if (xml && typeof xml === 'string') {
                            downloadReceived = true;
                            window.removeEventListener('message', handleDownload);
                            
                            console.log('[DEBUG] 准备下载文件，长度:', xml.length);
                            const blob = new Blob([xml], {type: 'text/xml'});
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = currentFilepath ? currentFilepath.split('/').pop() : 'diagram.drawio';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                    }
                } catch (e) {
                    console.error('[ERROR] 处理下载消息失败:', e);
                }
            };
            
            window.addEventListener('message', handleDownload);
            
            const exportMsg = JSON.stringify({
                action: 'export',
                format: 'xml'
            });
            drawioIframe.contentWindow.postMessage(exportMsg, '*');
            
            setTimeout(() => {
                if (!downloadReceived) {
                    window.removeEventListener('message', handleDownload);
                    alert('导出超时，请使用Draw.io菜单中的"文件→导出为→XML"功能');
                }
            }, 5000);
        }
        
        // 返回
        function goBack() {
            if (isModified) {
                if (confirm('您有未保存的更改，确定要离开吗？')) {
                    window.location.href = '{{ url_for("file_browser") }}';
                }
            } else {
                window.location.href = '{{ url_for("file_browser") }}';
            }
        }
        
        // 监听页面关闭
        window.addEventListener('beforeunload', function(e) {
            if (isModified) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>

