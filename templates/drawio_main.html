<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif;
        }
        
        /* æµ®åŠ¨å·¥å…·æ  */
        .floating-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toolbar-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .toolbar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .toolbar-btn:active {
            transform: translateY(-1px);
        }
        
        .toolbar-btn.save-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .toolbar-btn.download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .toolbar-btn.back-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .toolbar-btn .tooltip-text {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .toolbar-btn:hover .tooltip-text {
            opacity: 1;
        }
        
        /* ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        /* ä¿å­˜æç¤ºæ¡† */
        .save-hint {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            font-weight: bold;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .save-status.show {
            display: flex;
        }
        
        .save-status.saving {
            background: rgba(255, 193, 7, 0.95);
        }
        
        .save-status.saved {
            background: rgba(40, 167, 69, 0.95);
            color: white;
        }
        
        .save-status.error {
            background: rgba(220, 53, 69, 0.95);
            color: white;
        }
        
        .drawio-container {
            height: 100vh;
            width: 100vw;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #6c757d;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* æ–‡ä»¶åè¾“å…¥æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .modal-buttons .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .modal-buttons .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-buttons button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="save-status" class="save-status">
        <span class="spinner-border spinner-border-sm"></span>
        <span id="status-text">ä¿å­˜ä¸­...</span>
    </div>
    
    <!-- ä¿å­˜æç¤ºï¼ˆé¦–æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="save-hint" class="save-hint" style="display: none;">
        ğŸ’¾ æŒ‰Ctrl+Sä¿å­˜åˆ°æœåŠ¡å™¨
    </div>
    
    <!-- æµ®åŠ¨å·¥å…·æ  -->
    <div class="floating-toolbar">
        <button id="upload-btn" class="toolbar-btn upload-btn" title="æ‰“å¼€æœ¬åœ°æ–‡ä»¶" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            ğŸ“‚
            <span class="tooltip-text">æ‰“å¼€æœ¬åœ°æ–‡ä»¶</span>
        </button>
        <button id="download-btn" class="toolbar-btn download-btn" title="ä¸‹è½½åˆ°æœ¬åœ°">
            ğŸ“¥
            <span class="tooltip-text">ä¸‹è½½</span>
        </button>
        <button id="back-btn" class="toolbar-btn back-btn" title="è¿”å›">
            â†
            <span class="tooltip-text">è¿”å›</span>
        </button>
    </div>
    
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input" accept=".drawio,.xml,.dio" style="display: none;" />
    
    <!-- æ–‡ä»¶åè¾“å…¥æ¨¡æ€æ¡† -->
    <div id="filename-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>ä¿å­˜æ–‡ä»¶</h3>
            <input type="text" id="filename-input" placeholder="è¯·è¾“å…¥æ–‡ä»¶åï¼ˆè‡ªåŠ¨æ·»åŠ .drawioï¼‰" />
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeFilenameModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveWithFilename()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Draw.io ç¼–è¾‘å™¨å®¹å™¨ -->
    <div class="drawio-container">
        <div id="loading" class="loading-spinner">
            <div class="spinner-border spinner"></div>
            <span>æ­£åœ¨åŠ è½½ Draw.io ç¼–è¾‘å™¨...</span>
        </div>
        <iframe id="drawio-iframe" src="" style="display: none;"></iframe>
    </div>
    
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // ä»æœåŠ¡å™¨ä¼ é€’çš„æ•°æ®
        let currentFilepath = {{ filepath|tojson|safe }} || null;
        let initialContent = {{ diagram_content|tojson|safe }} || '';
        let isModified = false;
        let drawioIframe = null;
        let drawioReady = false;
        
        // æå–å½“å‰ç›®å½•è·¯å¾„ï¼ˆç”¨äºä¿å­˜æ–°æ–‡ä»¶ï¼‰
        let currentDir = '';
        if (currentFilepath) {
            const lastSlash = currentFilepath.lastIndexOf('/');
            if (lastSlash !== -1) {
                currentDir = currentFilepath.substring(0, lastSlash + 1);
            }
        }
        
        // è°ƒè¯•è¾“å‡º
        console.log('[DEBUG] ===== é¡µé¢åŠ è½½è°ƒè¯•ä¿¡æ¯ =====');
        console.log('[DEBUG] currentFilepath:', currentFilepath);
        console.log('[DEBUG] currentDir:', currentDir);
        console.log('[DEBUG] currentFilepath type:', typeof currentFilepath);
        console.log('[DEBUG] initialContent:', initialContent ? initialContent.substring(0, 100) + '...' : 'NULL');
        console.log('[DEBUG] initialContent length:', initialContent ? initialContent.length : 0);
        console.log('[DEBUG] initialContent type:', typeof initialContent);
        console.log('[DEBUG] ================================');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            drawioIframe = document.getElementById('drawio-iframe');
            
            // æ„å»ºiframe URL
            // é…ç½®Draw.ioä¸ºç¦»çº¿æ¨¡å¼ï¼Œä¿ç•™å®Œæ•´ç¼–è¾‘ç•Œé¢
            // embed=1: å¯ç”¨embedæ¨¡å¼ï¼Œæ”¯æŒpostMessage API
            // proto=json: ä½¿ç”¨JSONæ ¼å¼é€šä¿¡
            let iframeSrc = '/drawio?offline=1&stealth=1&local=1&sync=none&mode=device&lang=zh&embed=1&proto=json';
            
            console.log('[DEBUG] è®¾ç½®iframe src...');
            console.log('[DEBUG] æ˜¯å¦æœ‰åˆå§‹å†…å®¹:', !!initialContent, 'é•¿åº¦:', initialContent?.length);
            drawioIframe.src = iframeSrc;
            
            // ç›‘å¬Draw.ioçš„initäº‹ä»¶
            let drawioInitialized = false;
            const initListener = function(e) {
                try {
                    let data = e.data;
                    
                    // è§£æJSONå­—ç¬¦ä¸²
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (parseErr) {
                            return;
                        }
                    }
                    
                    // ç›‘å¬initäº‹ä»¶
                    if (data && data.event === 'init' && !drawioInitialized) {
                        console.log('[DEBUG] Draw.ioå·²åˆå§‹åŒ–ï¼ˆæ”¶åˆ°initäº‹ä»¶ï¼‰');
                        drawioInitialized = true;
                        
                        // Draw.ioåˆå§‹åŒ–å®Œæˆï¼Œç«‹å³åŠ è½½å†…å®¹
                        try {
                            if (initialContent && initialContent.length > 0) {
                                console.log('[DEBUG] ä½¿ç”¨postMessage loadåŠ¨ä½œåŠ è½½æ–‡ä»¶å†…å®¹');
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: initialContent,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] å·²å‘é€loadæ¶ˆæ¯ï¼ˆå“åº”initï¼‰ï¼Œå†…å®¹é•¿åº¦:', initialContent.length);
                            } else {
                                console.log('[DEBUG] æ²¡æœ‰åˆå§‹å†…å®¹ï¼Œåˆ›å»ºæ–°å›¾è¡¨');
                                const emptyDiagram = '<mxfile><diagram id="new" name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: emptyDiagram,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] å·²å‘é€ç©ºç™½å›¾è¡¨ï¼ˆå“åº”initï¼‰');
                            }
                            
                            // é…ç½®Draw.io
                            const configMsg = JSON.stringify({
                                action: 'configure',
                                config: {
                                    defaultEdgeLength: 80
                                }
                            });
                            drawioIframe.contentWindow.postMessage(configMsg, '*');
                            console.log('[DEBUG] å·²é…ç½®Draw.ioï¼ˆembedæ¨¡å¼ï¼‰');
                        } catch (e) {
                            console.error('[ERROR] é…ç½®æˆ–åŠ è½½Draw.ioå¤±è´¥:', e);
                        }
                    }
                } catch (err) {
                    // å¿½ç•¥
                }
            };
            window.addEventListener('message', initListener);
            
            // ç­‰å¾…iframeåŠ è½½å®Œæˆ
            drawioIframe.onload = function() {
                console.log('[DEBUG] iframeåŠ è½½å®Œæˆ');
                document.getElementById('loading').style.display = 'none';
                drawioIframe.style.display = 'block';
                drawioReady = true;
                
                // æ˜¾ç¤ºä¿å­˜æç¤ºï¼ˆ5ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰
                if (currentFilepath) {
                    const hint = document.getElementById('save-hint');
                    hint.style.display = 'block';
                    setTimeout(() => {
                        hint.style.opacity = '0';
                        hint.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 500);
                    }, 5000);
                }
                
                // å¤‡ç”¨ï¼šå¦‚æœ3ç§’å†…æ²¡æ”¶åˆ°initäº‹ä»¶ï¼Œå¼ºåˆ¶åŠ è½½
                setTimeout(() => {
                    if (!drawioInitialized) {
                        console.log('[DEBUG] è¶…æ—¶ï¼Œå¼ºåˆ¶åŠ è½½å†…å®¹');
                        try {
                            if (initialContent && initialContent.length > 0) {
                                console.log('[DEBUG] å¼ºåˆ¶ä½¿ç”¨postMessage loadåŠ¨ä½œåŠ è½½æ–‡ä»¶å†…å®¹');
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: initialContent,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] å·²å¼ºåˆ¶å‘é€loadæ¶ˆæ¯ï¼Œå†…å®¹é•¿åº¦:', initialContent.length);
                            } else {
                                console.log('[DEBUG] æ²¡æœ‰åˆå§‹å†…å®¹ï¼Œåˆ›å»ºæ–°å›¾è¡¨');
                                const emptyDiagram = '<mxfile><diagram id="new" name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
                                const loadMsg = JSON.stringify({
                                    action: 'load',
                                    xml: emptyDiagram,
                                    autosave: 1
                                });
                                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                                console.log('[DEBUG] å·²å¼ºåˆ¶å‘é€ç©ºç™½å›¾è¡¨');
                            }
                            
                            // é…ç½®Draw.io
                            const configMsg = JSON.stringify({
                                action: 'configure',
                                config: {
                                    defaultEdgeLength: 80
                                }
                            });
                            drawioIframe.contentWindow.postMessage(configMsg, '*');
                            console.log('[DEBUG] å·²é…ç½®Draw.ioï¼ˆembedæ¨¡å¼ï¼‰');
                        } catch (e) {
                            console.error('[ERROR] å¼ºåˆ¶é…ç½®æˆ–åŠ è½½Draw.ioå¤±è´¥:', e);
                        }
                    }
                }, 3000);
            };
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('upload-btn').addEventListener('click', openLocalFile);
            // save-btnå·²ç§»é™¤ï¼Œä½¿ç”¨Ctrl+Sä¿å­˜
            document.getElementById('download-btn').addEventListener('click', downloadFile);
            document.getElementById('back-btn').addEventListener('click', goBack);
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
            
            // å…¨å±€autosaveç›‘å¬å™¨ï¼ˆæ•è·æ‰€æœ‰autosaveäº‹ä»¶ï¼‰
            let lastAutosaveXml = null;
            window.addEventListener('message', function(e) {
                try {
                    let data = e.data;
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (parseErr) {
                            return;
                        }
                    }
                    
                    // å§‹ç»ˆè®°å½•æœ€æ–°çš„autosaveå†…å®¹
                    if (data && data.event === 'autosave' && data.xml) {
                        lastAutosaveXml = data.xml;
                        console.log('[DEBUG] è®°å½•autosaveå†…å®¹ï¼Œé•¿åº¦:', lastAutosaveXml.length);
                    }
                } catch (err) {
                    // å¿½ç•¥
                }
            });
            
            // ç›‘å¬é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl+S ä¿å­˜
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    // ç›´æ¥ä½¿ç”¨æœ€æ–°çš„autosaveå†…å®¹
                    if (lastAutosaveXml) {
                        console.log('[DEBUG] ä½¿ç”¨ç¼“å­˜çš„autosaveå†…å®¹ä¿å­˜');
                        if (currentFilepath) {
                            saveToServer(currentFilepath, lastAutosaveXml);
                        } else {
                            showFilenameModal(lastAutosaveXml);
                        }
                    } else {
                        saveFile();
                    }
                }
            });
            
            // ç›‘å¬æ¥è‡ªDraw.ioçš„æ¶ˆæ¯
            window.addEventListener('message', handleDrawioMessage);
            
            // é¢å¤–æ·»åŠ ä¸€ä¸ªè°ƒè¯•ç›‘å¬å™¨ï¼Œæ•è·æ‰€æœ‰æ¶ˆæ¯
            window.addEventListener('message', function(e) {
                try {
                    let data = e.data;
                    
                    // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                    let parsedData = data;
                    if (typeof data === 'string') {
                        try {
                            parsedData = JSON.parse(data);
                        } catch (parseErr) {
                            // ä¸æ˜¯JSONï¼Œä¿æŒåŸæ ·
                        }
                    }
                    
                    // è¯¦ç»†è®°å½•æ‰€æœ‰æ¶ˆæ¯
                    console.log('[DEBUG] æ”¶åˆ°åŸå§‹æ¶ˆæ¯:', {
                        dataType: typeof data,
                        isJSON: typeof data === 'string' && typeof parsedData === 'object',
                        event: parsedData?.event,
                        origin: e.origin,
                        source: e.source === drawioIframe?.contentWindow ? 'Draw.io iframe' : 'other'
                    });
                    
                    // ç‰¹åˆ«ç›‘å¬saveç›¸å…³çš„æ¶ˆæ¯
                    if (typeof parsedData === 'object' && parsedData !== null) {
                        if (parsedData.event === 'save' || parsedData.event === 'saveAs' || parsedData.event === 'autosave') {
                            console.log('[DEBUG] *** æ£€æµ‹åˆ°ä¿å­˜äº‹ä»¶ ***', parsedData.event);
                            
                            // å¦‚æœæ˜¯saveæˆ–saveAsäº‹ä»¶
                            if (parsedData.event === 'save' || parsedData.event === 'saveAs') {
                                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                                e.stopPropagation && e.stopPropagation();
                                
                                // è·å–XMLå†…å®¹å¹¶ä¿å­˜åˆ°æœåŠ¡å™¨
                                if (parsedData.xml) {
                                    console.log('[DEBUG] ä¿å­˜äº‹ä»¶åŒ…å«XMLï¼Œé•¿åº¦:', parsedData.xml.length);
                                    if (currentFilepath) {
                                        saveToServer(currentFilepath, parsedData.xml);
                                    } else {
                                        showFilenameModal(parsedData.xml);
                                    }
                                } else {
                                    console.log('[DEBUG] ä¿å­˜äº‹ä»¶ä¸åŒ…å«XMLï¼Œè¯·æ±‚å¯¼å‡º');
                                    saveFile();
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error('[ERROR] å¤„ç†åŸå§‹æ¶ˆæ¯å¤±è´¥:', err);
                }
            });
        });
        
        // æ‰“å¼€æœ¬åœ°æ–‡ä»¶
        function openLocalFile() {
            document.getElementById('file-input').click();
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const xml = e.target.result;
                
                // ç¡®ä¿æ–‡ä»¶åæœ‰.drawioæ‰©å±•å
                let filename = file.name;
                if (!filename.endsWith('.drawio')) {
                    filename += '.drawio';
                }
                
                // ä¿å­˜åˆ°å½“å‰ç›®å½•
                const uploadFilepath = currentDir ? currentDir + filename : filename;
                console.log('[DEBUG] ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°:', uploadFilepath);
                
                // ä¿å­˜åˆ°æœåŠ¡å™¨
                saveToServer(uploadFilepath, xml);
                
                // åŠ è½½åˆ°ç¼–è¾‘å™¨ï¼ˆä½¿ç”¨embedæ¨¡å¼çš„loadï¼‰
                const loadMsg = JSON.stringify({
                    action: 'load',
                    xml: xml,
                    autosave: 1
                });
                drawioIframe.contentWindow.postMessage(loadMsg, '*');
                
                currentFilepath = uploadFilepath;
                showSaveStatus('saved', 'æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨');
            };
            
            reader.readAsText(file);
            
            // é‡ç½®inputä»¥å…è®¸é‡æ–°é€‰æ‹©ç›¸åŒæ–‡ä»¶
            event.target.value = '';
        }
        
        // å¤„ç†æ¥è‡ªDraw.ioçš„æ¶ˆæ¯
        function handleDrawioMessage(event) {
            try {
                let data = event.data;
                
                // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æå®ƒ
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        // ä¸æ˜¯JSONï¼Œå¿½ç•¥
                        return;
                    }
                }
                
                if (typeof data === 'object' && data !== null) {
                    console.log('[DEBUG] æ”¶åˆ°Draw.ioæ¶ˆæ¯:', data);
                    
                    // ç›‘å¬å†…å®¹å˜åŒ–
                    if (data.event === 'modified') {
                        isModified = true;
                        console.log('[DEBUG] å†…å®¹å·²ä¿®æ”¹');
                    }
                    
                    // æ‹¦æˆªä¿å­˜äº‹ä»¶
                    if (data.event === 'save') {
                        console.log('[DEBUG] æ‹¦æˆªåˆ°Draw.ioçš„ä¿å­˜äº‹ä»¶');
                        event.preventDefault && event.preventDefault();
                        
                        // å¦‚æœæœ‰æ–‡ä»¶è·¯å¾„ï¼Œä¿å­˜åˆ°æœåŠ¡å™¨ï¼›å¦åˆ™è¯¢é—®æ–‡ä»¶å
                        if (data.xml) {
                            if (currentFilepath) {
                                saveToServer(currentFilepath, data.xml);
                            } else {
                                showFilenameModal(data.xml);
                            }
                        } else {
                            // å¦‚æœäº‹ä»¶ä¸­æ²¡æœ‰xmlï¼Œä¸»åŠ¨è¯·æ±‚å¯¼å‡º
                            saveFile();
                        }
                        return;
                    }
                    
                    // ç›‘å¬è‡ªåŠ¨ä¿å­˜
                    if (data.event === 'autosave') {
                        console.log('[DEBUG] è‡ªåŠ¨ä¿å­˜äº‹ä»¶è§¦å‘');
                        if (currentFilepath && data.xml) {
                            autoSaveToServer(data.xml);
                        }
                    }
                    
                // å“åº”å¯¼å‡ºè¯·æ±‚ï¼ˆå·²åœ¨saveFileä¸­å¤„ç†ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†ï¼‰
                // if (data.event === 'export' && data.data) {
                //     // å¯¼å‡ºäº‹ä»¶å·²ç”±saveFileå‡½æ•°å¤„ç†
                // }
                }
            } catch (e) {
                console.error('[ERROR] å¤„ç†Draw.ioæ¶ˆæ¯å¤±è´¥:', e);
            }
        }
        
        // ä¿å­˜æ–‡ä»¶
        function saveFile() {
            console.log('[DEBUG] è¯·æ±‚ä¿å­˜...');
            showSaveStatus('saving');
            
            // æ–¹æ¡ˆï¼šæ¨¡æ‹ŸCtrl+SæŒ‰é”®ï¼Œè§¦å‘Draw.ioçš„autosave
            try {
                console.log('[DEBUG] æ¨¡æ‹ŸCtrl+Så¿«æ·é”®...');
                
                // è®¾ç½®autosaveç›‘å¬å™¨
                let saveReceived = false;
                const handleAutosave = function(event) {
                    try {
                        let data = event.data;
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);
                            } catch (e) {
                                return;
                            }
                        }
                        
                        if (data && data.event === 'autosave' && data.xml && !saveReceived) {
                            saveReceived = true;
                            window.removeEventListener('message', handleAutosave);
                            
                            const xml = data.xml;
                            console.log('[DEBUG] æ•è·autosaveï¼ŒXMLé•¿åº¦:', xml.length);
                            console.log('[DEBUG] XMLå‰100å­—ç¬¦:', xml.substring(0, 100));
                            
                            if (!xml.includes('<mxfile') && !xml.includes('<?xml')) {
                                console.error('[ERROR] XMLæ ¼å¼æ— æ•ˆ');
                                showSaveStatus('error', 'ä¿å­˜å¤±è´¥');
                                return;
                            }
                            
                            if (currentFilepath) {
                                saveToServer(currentFilepath, xml);
                            } else {
                                showFilenameModal(xml);
                            }
                        }
                    } catch (e) {
                        console.error('[ERROR]', e);
                    }
                };
                
                window.addEventListener('message', handleAutosave);
                
                // å‘iframeå‘é€Ctrl+SæŒ‰é”®äº‹ä»¶
                const iframe = drawioIframe;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // åˆ›å»ºé”®ç›˜äº‹ä»¶
                const keydownEvent = new KeyboardEvent('keydown', {
                    key: 's',
                    code: 'KeyS',
                    keyCode: 83,
                    which: 83,
                    ctrlKey: true,
                    bubbles: true,
                    cancelable: true
                });
                
                const keyupEvent = new KeyboardEvent('keyup', {
                    key: 's',
                    code: 'KeyS',
                    keyCode: 83,
                    which: 83,
                    ctrlKey: true,
                    bubbles: true,
                    cancelable: true
                });
                
                console.log('[DEBUG] è§¦å‘é”®ç›˜äº‹ä»¶...');
                iframeDoc.dispatchEvent(keydownEvent);
                iframeDoc.dispatchEvent(keyupEvent);
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    if (!saveReceived) {
                        console.warn('[WARN] æœªæ•è·åˆ°autosaveäº‹ä»¶');
                        window.removeEventListener('message', handleAutosave);
                        showSaveStatus('saved', 'å·²è§¦å‘ä¿å­˜');
                        
                        // æç¤ºç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤
                        setTimeout(() => {
                            if (confirm('æœªæ£€æµ‹åˆ°è‡ªåŠ¨ä¿å­˜å“åº”ã€‚\n\nè¯·åœ¨Draw.ioä¸­æŒ‰Ctrl+Sä¿å­˜ï¼Œç„¶åç‚¹å‡»"ç¡®å®š"å†æ¬¡å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚')) {
                                saveFile();
                            } else {
                                showSaveStatus('error');
                            }
                        }, 100);
                    }
                }, 2000);
                
            } catch (e) {
                console.error('[ERROR] ä¿å­˜å¤±è´¥:', e);
                showSaveStatus('error');
            }
        }
        
        // ä¿å­˜åˆ°æœåŠ¡å™¨
        function saveToServer(filepath, content) {
            showSaveStatus('saving');
            
            fetch('/drawio_save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filepath: filepath,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSaveStatus('saved');
                    isModified = false;
                    currentFilepath = filepath;
                } else {
                    showSaveStatus('error', data.error || 'ä¿å­˜å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é”™è¯¯:', error);
                showSaveStatus('error', 'ç½‘ç»œé”™è¯¯');
            });
        }
        
        // è‡ªåŠ¨ä¿å­˜ï¼ˆé™é»˜ï¼‰
        function autoSaveToServer(content) {
            if (!currentFilepath) return;
            
            fetch('/drawio_save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filepath: currentFilepath,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('è‡ªåŠ¨ä¿å­˜æˆåŠŸ');
                }
            })
            .catch(error => {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            });
        }
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
        function showSaveStatus(status, message) {
            const statusEl = document.getElementById('save-status');
            const textEl = document.getElementById('status-text');
            
            statusEl.className = 'save-status show ' + status;
            
            if (status === 'saving') {
                textEl.textContent = 'ä¿å­˜ä¸­...';
            } else if (status === 'saved') {
                textEl.textContent = message || 'ä¿å­˜æˆåŠŸ âœ“';
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 2000);
            } else if (status === 'error') {
                textEl.textContent = message || 'ä¿å­˜å¤±è´¥ âœ—';
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åè¾“å…¥æ¡†
        function showFilenameModal(xml) {
            window.pendingXml = xml;
            document.getElementById('filename-modal').classList.add('show');
            document.getElementById('filename-input').focus();
        }
        
        // å…³é—­æ–‡ä»¶åè¾“å…¥æ¡†
        function closeFilenameModal() {
            document.getElementById('filename-modal').classList.remove('show');
            window.pendingXml = null;
        }
        
        // ä½¿ç”¨æ–‡ä»¶åä¿å­˜
        function saveWithFilename() {
            let filename = document.getElementById('filename-input').value.trim();
            
            if (!filename) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }
            
            // ç¡®ä¿æœ‰.drawioæ‰©å±•å
            if (!filename.endsWith('.drawio')) {
                filename += '.drawio';
            }
            
            // ä¿å­˜åˆ°å½“å‰ç›®å½•ï¼Œå¦‚æœæ²¡æœ‰å½“å‰ç›®å½•åˆ™ä¿å­˜åˆ°æ ¹ç›®å½•
            const filepath = currentDir ? currentDir + filename : filename;
            console.log('[DEBUG] ä¿å­˜æ–°æ–‡ä»¶åˆ°:', filepath);
            
            // æ›´æ–°currentFilepathä»¥ä¾¿åç»­ä¿å­˜
            currentFilepath = filepath;
            
            saveToServer(filepath, window.pendingXml);
            closeFilenameModal();
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile() {
            console.log('[DEBUG] è¯·æ±‚ä¸‹è½½æ–‡ä»¶...');
            
            let downloadReceived = false;
            
            const handleDownload = function(event) {
                try {
                    let data = event.data;
                    
                    // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œè§£æå®ƒ
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch (e) {
                            return;
                        }
                    }
                    
                    if (data && data.event === 'export' && !downloadReceived) {
                        const xml = data.data || data.xml;
                        if (xml && typeof xml === 'string') {
                            downloadReceived = true;
                            window.removeEventListener('message', handleDownload);
                            
                            console.log('[DEBUG] å‡†å¤‡ä¸‹è½½æ–‡ä»¶ï¼Œé•¿åº¦:', xml.length);
                            const blob = new Blob([xml], {type: 'text/xml'});
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = currentFilepath ? currentFilepath.split('/').pop() : 'diagram.drawio';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                    }
                } catch (e) {
                    console.error('[ERROR] å¤„ç†ä¸‹è½½æ¶ˆæ¯å¤±è´¥:', e);
                }
            };
            
            window.addEventListener('message', handleDownload);
            
            const exportMsg = JSON.stringify({
                action: 'export',
                format: 'xml'
            });
            drawioIframe.contentWindow.postMessage(exportMsg, '*');
            
            setTimeout(() => {
                if (!downloadReceived) {
                    window.removeEventListener('message', handleDownload);
                    alert('å¯¼å‡ºè¶…æ—¶ï¼Œè¯·ä½¿ç”¨Draw.ioèœå•ä¸­çš„"æ–‡ä»¶â†’å¯¼å‡ºä¸ºâ†’XML"åŠŸèƒ½');
                }
            }, 5000);
        }
        
        // è¿”å›
        function goBack() {
            if (isModified) {
                if (confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ')) {
                    window.location.href = '{{ url_for("file_browser") }}';
                }
            } else {
                window.location.href = '{{ url_for("file_browser") }}';
            }
        }
        
        // ç›‘å¬é¡µé¢å…³é—­
        window.addEventListener('beforeunload', function(e) {
            if (isModified) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>

